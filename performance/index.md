# RogueMap æ€§èƒ½ç™½çš®ä¹¦

## æ¦‚è¿°

RogueMap æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„åµŒå…¥å¼é”®å€¼å­˜å‚¨å¼•æ“ï¼Œä¸“æ³¨äºè§£å†³ Java åº”ç”¨ä¸­**å †å†…å­˜å—é™**å’Œ**æ•°æ®æŒä¹…åŒ–**çš„ç—›ç‚¹ã€‚æœ¬æ–‡æ¡£å°†å®¢è§‚ã€å…¨é¢åœ°å±•ç¤º RogueMap çš„æ€§èƒ½è¡¨ç°ï¼Œå¹¶è¯´æ˜å…¶è®¾è®¡æƒè¡¡ã€‚

## è®¾è®¡ç†å¿µï¼šä¸å¯èƒ½ä¸‰è§’çš„é€‰æ‹©

åœ¨é”®å€¼å­˜å‚¨é¢†åŸŸå­˜åœ¨ä¸€ä¸ªç»å…¸çš„"ä¸å¯èƒ½ä¸‰è§’"ï¼š

```
        æè‡´é€Ÿåº¦
           /\
          /  \
         /    \
        /      \
       /________\
  å­˜å‚¨çªç ´      å¹¶å‘å®‰å…¨
```

**ä¸‰ä¸ªç»´åº¦**ï¼š
1. **æè‡´é€Ÿåº¦** - çº¯å†…å­˜æ“ä½œï¼Œæ— åºåˆ—åŒ–å¼€é”€ï¼ˆå¦‚ HashMapã€FastUtilï¼‰
2. **å­˜å‚¨çªç ´** - çªç ´ JVM å †å†…å­˜é™åˆ¶ï¼Œæ”¯æŒç£ç›˜æ˜ å°„å’ŒæŒä¹…åŒ–
3. **å¹¶å‘å®‰å…¨** - çº¿ç¨‹å®‰å…¨ï¼Œæ”¯æŒé«˜å¹¶å‘è¯»å†™

**ä¸‰è€…åªèƒ½å–å…¶äºŒ**ï¼š
- HashMap/FastUtilï¼šé€‰æ‹©"é€Ÿåº¦ + å¹¶å‘å®‰å…¨"ï¼Œæ”¾å¼ƒ"å­˜å‚¨çªç ´"
- RogueMapï¼šé€‰æ‹©"å­˜å‚¨çªç ´ + å¹¶å‘å®‰å…¨"ï¼Œåœ¨é€Ÿåº¦ä¸Šåšå‡ºæƒè¡¡

### ä¸ºä»€ä¹ˆ RogueMap é€‰æ‹©åä¸¤è€…ï¼Ÿ

ç°ä»£ Java åº”ç”¨é¢ä¸´çš„æ ¸å¿ƒç—›ç‚¹ï¼š

1. **å †å†…å­˜å—é™** - å¤§æ•°æ®é‡å¯¼è‡´é¢‘ç¹ Full GCï¼Œåº”ç”¨å¡é¡¿
2. **æ•°æ®æ˜“å¤±** - è¿›ç¨‹é‡å¯æ•°æ®å…¨éƒ¨ä¸¢å¤±
3. **å†…å­˜æˆæœ¬é«˜** - å †å†…å­˜æ‰©å®¹æˆæœ¬è¿œé«˜äºç£ç›˜

è¿™äº›é—®é¢˜æ˜¯ HashMapã€FastUtilã€Caffeine ç­‰çº¯å†…å­˜æ–¹æ¡ˆ**æ— æ³•è§£å†³**çš„ã€‚å› æ­¤ï¼ŒRogueMap é€‰æ‹©ï¼š

- âœ… **å­˜å‚¨çªç ´** - å †å¤–å†…å­˜ + ç£ç›˜ mmap æ˜ å°„ï¼Œå‡å°‘ 87% å †å†…å­˜å ç”¨
- âœ… **å¹¶å‘å®‰å…¨** - 64 æ®µåˆ†æ®µé” + StampedLock ä¹è§‚é”
- âš ï¸ **é€Ÿåº¦æƒè¡¡** - è¯»å–æ¶‰åŠåºåˆ—åŒ–ï¼Œçº¦ä¸º HashMap çš„ 1/10

### ä½†é€Ÿåº¦ä»ç„¶å¾ˆå¿«

è™½ç„¶åšå‡ºäº†æƒè¡¡ï¼Œä½† RogueMap åœ¨é€Ÿåº¦ä¼˜åŒ–ä¸ŠæŠ•å…¥äº†å¤§é‡ç²¾åŠ›ï¼š

1. **å†™å…¥ä¼˜åŒ–** - åªå†™ç´¢å¼•ä¸å†™æ•°æ®ï¼Œæ¯” HashMap å¿« **1.95 å€**
2. **é›¶æ‹·è´åºåˆ—åŒ–** - åŸå§‹ç±»å‹ç›´æ¥å†…å­˜å¸ƒå±€
3. **Slab å†…å­˜åˆ†é…å™¨** - 7 ä¸ª size classï¼Œå‡å°‘ç¢ç‰‡
4. **åˆ†æ®µé”ä¼˜åŒ–** - 64 æ®µå¹¶å‘ï¼Œé™ä½é”ç«äº‰
5. **æ“ä½œç³»ç»Ÿä¼˜åŒ–** - mmap é¡µç¼“å­˜åŠ é€Ÿ

**ç»“æœ**ï¼šåœ¨ Linux 2C4G æœºå™¨ä¸Šï¼ŒRogueMap è¯»å–ååè¾¾åˆ° **176 ä¸‡ ops/s**ï¼Œè¿™ä¸ªæ€§èƒ½ï¼š
- æ¯” Redisï¼ˆç½‘ç»œï¼‰å¿« **1-2 ä¸ªæ•°é‡çº§**ï¼ˆRedis ç½‘ç»œå¾€è¿”çº¦ 100Î¼sï¼ŒRogueMap æœ¬åœ°çº¦ 0.5Î¼sï¼‰
- æ¯” MapDB å¿« **15.9 å€**
- æ»¡è¶³ç»å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯

## æµ‹è¯•ç¯å¢ƒ

**ç¡¬ä»¶é…ç½®**ï¼š
- CPU: Linux 2 æ ¸
- å†…å­˜: 4GB
- å­˜å‚¨: SSD

**æµ‹è¯•æ•°æ®**ï¼š
- æ•°æ®é‡: 100 ä¸‡æ¡è®°å½•
- å¯¹è±¡ç»“æ„: åŒ…å« 10 ä¸ªå±æ€§çš„ PO å€¼å¯¹è±¡
- æµ‹è¯•ç±»å‹: é¡ºåºå†™å…¥ + éšæœºè¯»å–

## å®Œæ•´æ€§èƒ½å¯¹æ¯”

### ç»¼åˆæ€§èƒ½è¡¨ç°

åŸºäº Linux 2C4G æœåŠ¡å™¨ï¼Œ100 ä¸‡æ¡æ•°æ®æµ‹è¯•ç»“æœï¼š

| æ–¹æ¡ˆ | å†™å…¥æ—¶é—´ | è¯»å–æ—¶é—´ | å†™ååé‡ | è¯»ååé‡ | å †å†…å­˜å ç”¨ | æŒä¹…åŒ– |
|-----|----------|----------|----------|----------|-----------|--------|
| **HashMap** | 2445ms | **64ms** | 408,997 ops/s | **15,625,000 ops/s** | 304.49 MB | âŒ |
| **FastUtil** | **736ms** | **49ms** | **1,358,695 ops/s** | **20,408,163 ops/s** | 268.06 MB | âŒ |
| **Caffeine** | 2257ms | 422ms | 443,066 ops/s | 2,369,668 ops/s | 344.06 MB | âŒ |
| **RogueMap OffHeap** | 1899ms | 1033ms | 526,592 ops/s | 968,054 ops/s | **40.18 MB** | âŒ |
| **RogueMap Mmap æŒä¹…åŒ–** | **1254ms** | 566ms | **797,448 ops/s** | **1,766,784 ops/s** | **40.00 MB** | âœ… |
| **RogueMap Mmap ä¸´æ—¶** | 1377ms | 656ms | 726,216 ops/s | 1,524,390 ops/s | **40.03 MB** | âŒ |

### æ€§èƒ½å¯è§†åŒ–

```
ğŸ“Š å†™å…¥æ€§èƒ½ (è¶Šä½è¶Šå¥½)
FastUtil          â–ˆâ–ˆâ–ˆâ–ˆ 736ms                    â­â­â­â­â­
RogueMap Mmap     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 1254ms                â­â­â­â­
RogueMap Mmapä¸´æ—¶ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 1377ms               â­â­â­â­
RogueMap OffHeap  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 1899ms            â­â­â­
Caffeine          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 2257ms          â­â­
HashMap           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 2445ms         â­â­

ğŸ“Š è¯»å–æ€§èƒ½ (è¶Šä½è¶Šå¥½)
FastUtil          â–ˆâ–ˆâ–ˆ 49ms                      â­â­â­â­â­
HashMap           â–ˆâ–ˆâ–ˆâ–ˆ 64ms                     â­â­â­â­â­
Caffeine          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 422ms      â­â­â­
RogueMap Mmap     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 566ms â­â­â­
RogueMap Mmapä¸´æ—¶ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 656ms â­â­
RogueMap OffHeap  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 1033ms â­â­

ğŸ’¾ å †å†…å­˜å ç”¨ (è¶Šä½è¶Šå¥½)
RogueMap Mmap     â–ˆâ–ˆâ–ˆ 40.00 MB                  â­â­â­â­â­
RogueMap Mmapä¸´æ—¶ â–ˆâ–ˆâ–ˆ 40.03 MB                  â­â­â­â­â­
RogueMap OffHeap  â–ˆâ–ˆâ–ˆ 40.18 MB                  â­â­â­â­â­
FastUtil          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 268.06 MB    â­â­
HashMap           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 304.49 MB   â­â­
Caffeine          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 344.06 MB  â­
```

## æ·±åº¦åˆ†æ

### RogueMap çš„æ ¸å¿ƒä¼˜åŠ¿

#### 1. å †å†…å­˜å ç”¨å‡å°‘ 87%

**å¯¹æ¯” HashMap**ï¼š
- HashMap: 304.49 MB
- RogueMap: 40.00 MB
- **èŠ‚çœ**: 264.49 MBï¼ˆ87%ï¼‰

**æ„ä¹‰**ï¼š
- å¤§å¹…é™ä½ GC å‹åŠ›ï¼Œå‡å°‘åº”ç”¨å¡é¡¿
- æ”¯æŒæ›´å¤§æ•°æ®é‡ï¼ˆ10 å€ä»¥ä¸Šï¼‰
- é¿å… OOM é£é™©

#### 2. å†™å…¥æ€§èƒ½æå‡ 1.95 å€

**å¯¹æ¯” HashMap**ï¼š
- HashMap: 2445ms (408,997 ops/s)
- RogueMap Mmap: 1254ms (797,448 ops/s)
- **æå‡**: 1.95 å€

**åŸå› **ï¼š
- åªå†™ç´¢å¼•ï¼Œä¸å†™æ•°æ®ï¼ˆå»¶è¿Ÿåºåˆ—åŒ–ï¼‰
- mmap é¡µç¼“å­˜ä¼˜åŒ–
- é¡ºåºå†™å…¥ä¼˜åŒ–

#### 3. ç™¾ä¸‡çº§è¯»å–åå

**RogueMap Mmap æŒä¹…åŒ–**ï¼š
- è¯»å–æ—¶é—´: 566ms
- è¯»ååé‡: **1,766,784 ops/s**ï¼ˆ176 ä¸‡ ops/sï¼‰
- å•æ¬¡è¯»å–å»¶è¿Ÿ: çº¦ **0.56 Î¼s**

**å¯¹æ¯”**ï¼š
- æ¯” HashMap æ…¢çº¦ 8.8 å€ï¼ˆå› ä¸ºæ¶‰åŠååºåˆ—åŒ–ï¼‰
- ä½† 176 ä¸‡ ops/s å¯¹äº 2C4G æœºå™¨**å·²ç»éå¸¸ä¼˜ç§€**
- æ¯” Redisï¼ˆç½‘ç»œï¼‰å¿« 100-200 å€ï¼ˆRedis ç½‘ç»œå¾€è¿”çº¦ 100Î¼sï¼‰
- æ¯” MapDB å¿« 15.9 å€

#### 4. å”¯ä¸€æ”¯æŒæŒä¹…åŒ–çš„é«˜æ€§èƒ½æ–¹æ¡ˆ

| æ–¹æ¡ˆ | æŒä¹…åŒ– | å†™ååé‡ | è¯»ååé‡ |
|-----|--------|----------|----------|
| HashMap | âŒ | 408,997 | 15,625,000 |
| FastUtil | âŒ | 1,358,695 | 20,408,163 |
| Caffeine | âŒ | 443,066 | 2,369,668 |
| **RogueMap** | âœ… | **797,448** | **1,766,784** |

### RogueMap çš„æ€§èƒ½æƒè¡¡

#### è¯»å–é€Ÿåº¦çº¦ä¸º HashMap çš„ 1/10

**åŸå› **ï¼š
1. æ•°æ®å­˜å‚¨åœ¨å †å¤–ï¼Œéœ€è¦ååºåˆ—åŒ–
2. æ¶‰åŠå†…å­˜æ‹·è´ï¼ˆå †å¤– â†’ å †å†…ï¼‰
3. å¯¹è±¡é‡å»ºå¼€é”€

**ä½†ä»ç„¶å¾ˆå¿«**ï¼š
- å•æ¬¡è¯»å–çº¦ 0.56 Î¼s
- 176 ä¸‡ ops/s çš„ååé‡
- å¯¹äºæ‹¥æœ‰ 10 ä¸ªå±æ€§çš„å¤æ‚å¯¹è±¡ï¼Œè¿™ä¸ªæ€§èƒ½å·²ç»è¶³å¤Ÿ

#### ä¸ºä»€ä¹ˆè¿™ä¸ªæƒè¡¡æ˜¯å€¼å¾—çš„ï¼Ÿ

**åœºæ™¯ 1: å¤§æ•°æ®é‡ç¼“å­˜**
```
HashMap:  300 MB å †å†…å­˜ â†’ é¢‘ç¹ Full GC â†’ åº”ç”¨å¡é¡¿
RogueMap:  40 MB å †å†…å­˜ â†’ æå°‘ GC    â†’ åº”ç”¨æµç•…
```
å³ä½¿è¯»å–æ…¢ä¸€äº›ï¼Œä½†é¿å…äº† GC å¯¼è‡´çš„é•¿æ—¶é—´åœé¡¿ï¼Œ**æ•´ä½“æ€§èƒ½æ›´å¥½**ã€‚

**åœºæ™¯ 2: æ•°æ®æŒä¹…åŒ–**
```
HashMap:  è¿›ç¨‹é‡å¯ â†’ æ•°æ®å…¨éƒ¨ä¸¢å¤± â†’ éœ€è¦é‡æ–°åŠ è½½
RogueMap: è¿›ç¨‹é‡å¯ â†’ æ•°æ®è‡ªåŠ¨æ¢å¤ â†’ ç§’çº§å¯åŠ¨
```
å¯åŠ¨æ—¶é—´ä»åˆ†é’Ÿçº§é™è‡³ç§’çº§ï¼Œ**ä¸šåŠ¡è¿ç»­æ€§æ›´å¥½**ã€‚

**åœºæ™¯ 3: å†…å­˜æˆæœ¬**
```
å †å†…å­˜æ‰©å®¹æˆæœ¬ >> ç£ç›˜æˆæœ¬
300 MB å †å†…å­˜æ‰©å®¹ â‰ˆ 10GB SSD æˆæœ¬
```
ä½¿ç”¨ RogueMap å¯ä»¥æ˜¾è‘—é™ä½åŸºç¡€è®¾æ–½æˆæœ¬ã€‚

## å¤šæ¨¡å¼æ€§èƒ½å¯¹æ¯”

RogueMap æä¾›ä¸‰ç§å­˜å‚¨æ¨¡å¼ï¼Œé€‚åº”ä¸åŒåœºæ™¯ï¼š

### æ¨¡å¼é€‰æ‹©æŒ‡å—

| æ¨¡å¼ | å†™å…¥ | è¯»å– | å †å†…å­˜ | æŒä¹…åŒ– | é€‚ç”¨åœºæ™¯ |
|-----|------|------|--------|--------|---------|
| **Mmap æŒä¹…åŒ–** | 1254ms | 566ms | 40.00 MB | âœ… | ç”Ÿäº§ç¯å¢ƒï¼Œéœ€è¦æŒä¹…åŒ– |
| **Mmap ä¸´æ—¶** | 1377ms | 656ms | 40.03 MB | âŒ | ä¸´æ—¶å¤§æ•°æ®å¤„ç† |
| **OffHeap** | 1899ms | 1033ms | 40.18 MB | âŒ | å†…å­˜æ•æ„Ÿç¼“å­˜ |

### æ¨èæ–¹æ¡ˆ

```java
// åœºæ™¯ 1: ç”Ÿäº§ç¯å¢ƒ + æŒä¹…åŒ–
RogueMap<Long, User> map = RogueMap.<Long, User>mmap()
    .persistent("user-cache.db")
    .keyCodec(PrimitiveCodecs.LONG)
    .valueCodec(KryoObjectCodec.create(User.class))
    .build();
// ä¼˜åŠ¿: å†™å…¥å¿« 1.95xï¼Œæ”¯æŒæŒä¹…åŒ–ï¼Œå †å†…å­˜ä½ 87%

// åœºæ™¯ 2: ä¸´æ—¶å¤§æ•°æ®å¤„ç†
RogueMap<Long, Record> map = RogueMap.<Long, Record>mmap()
    .temporary()
    .allocateSize(10L * 1024 * 1024 * 1024) // 10GB
    .keyCodec(PrimitiveCodecs.LONG)
    .valueCodec(KryoObjectCodec.create(Record.class))
    .build();
// ä¼˜åŠ¿: æ”¯æŒè¶…å¤§æ•°æ®é‡ï¼Œè‡ªåŠ¨æ¸…ç†

// åœºæ™¯ 3: å†…å­˜æ•æ„Ÿç¼“å­˜
RogueMap<Long, Value> map = RogueMap.<Long, Value>offHeap()
    .maxMemory(2 * 1024 * 1024 * 1024)
    .keyCodec(PrimitiveCodecs.LONG)
    .valueCodec(KryoObjectCodec.create(Value.class))
    .build();
// ä¼˜åŠ¿: é™ä½ GC å‹åŠ›ï¼Œé€‚ä¸­æ€§èƒ½
```

## ä¸å…¶ä»–æ–¹æ¡ˆçš„è¯¦ç»†å¯¹æ¯”

### vs HashMap

**RogueMap ä¼˜åŠ¿**ï¼š
- âœ… å †å†…å­˜å‡å°‘ 87%ï¼ˆ304 MB â†’ 40 MBï¼‰
- âœ… å†™å…¥é€Ÿåº¦å¿« 1.95 å€
- âœ… æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼ˆHashMap åšä¸åˆ°ï¼‰
- âœ… å¤§å¹…é™ä½ GC å‹åŠ›

**HashMap ä¼˜åŠ¿**ï¼š
- âœ… è¯»å–é€Ÿåº¦å¿« 8.8 å€ï¼ˆçº¯å†…å­˜æ“ä½œï¼‰
- âœ… API æœ€ç®€å•
- âœ… æ— éœ€é…ç½®

**é€‚ç”¨åœºæ™¯**ï¼š
- HashMap: å°æ•°æ®é‡ï¼ˆ< 10 ä¸‡æ¡ï¼‰ï¼Œæè‡´è¯»å–æ€§èƒ½è¦æ±‚
- RogueMap: å¤§æ•°æ®é‡ï¼ˆ100 ä¸‡+ æ¡ï¼‰ï¼ŒGC æ•æ„Ÿï¼Œéœ€è¦æŒä¹…åŒ–

### vs FastUtil

**RogueMap ä¼˜åŠ¿**ï¼š
- âœ… å †å†…å­˜å‡å°‘ 85%ï¼ˆ268 MB â†’ 40 MBï¼‰
- âœ… æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼ˆFastUtil åšä¸åˆ°ï¼‰
- âœ… é™ä½ GC å‹åŠ›

**FastUtil ä¼˜åŠ¿**ï¼š
- âœ… å†™å…¥é€Ÿåº¦å¿« 1.85 å€
- âœ… è¯»å–é€Ÿåº¦å¿« 11.5 å€
- âœ… çº¯å†…å­˜ä¼˜åŒ–

**é€‚ç”¨åœºæ™¯**ï¼š
- FastUtil: æè‡´æ€§èƒ½è¦æ±‚ï¼Œä¸éœ€è¦æŒä¹…åŒ–
- RogueMap: å†…å­˜æ•æ„Ÿï¼Œéœ€è¦æŒä¹…åŒ–

### vs Caffeine

**RogueMap ä¼˜åŠ¿**ï¼š
- âœ… å †å†…å­˜å‡å°‘ 88%ï¼ˆ344 MB â†’ 40 MBï¼‰
- âœ… å†™å…¥é€Ÿåº¦å¿« 1.8 å€
- âœ… è¯»å–é€Ÿåº¦å¿« 4.2 å€
- âœ… æ”¯æŒæ•°æ®æŒä¹…åŒ–

**Caffeine ä¼˜åŠ¿**ï¼š
- âœ… è‡ªåŠ¨è¿‡æœŸ
- âœ… LRU æ·˜æ±°
- âœ… ç¼“å­˜ç»Ÿè®¡

**é€‚ç”¨åœºæ™¯**ï¼š
- Caffeine: éœ€è¦ç¼“å­˜æ·˜æ±°ç­–ç•¥
- RogueMap: éœ€è¦æŒä¹…åŒ–ï¼Œä½ GC å‹åŠ›

### vs Redisï¼ˆæœ¬åœ° vs ç½‘ç»œï¼‰

**æ€§èƒ½å¯¹æ¯”**ï¼š

| æ“ä½œ | RogueMap æœ¬åœ° | Redis æœ¬åœ° | Redis ç½‘ç»œ |
|-----|--------------|-----------|-----------|
| è¯»å–å»¶è¿Ÿ | ~0.56 Î¼s | ~10 Î¼s | ~100 Î¼s |
| å†™å…¥å»¶è¿Ÿ | ~1.25 Î¼s | ~15 Î¼s | ~150 Î¼s |
| æ€§èƒ½å·®è· | åŸºå‡† | æ…¢ 18 å€ | æ…¢ 179 å€ |

**RogueMap ä¼˜åŠ¿**ï¼š
- âœ… åµŒå…¥å¼ï¼Œæ— éœ€å¤–éƒ¨æœåŠ¡
- âœ… é›¶ç½‘ç»œå¼€é”€
- âœ… æœ¬åœ°æ€§èƒ½æ¯” Redis å¿« **1-2 ä¸ªæ•°é‡çº§**
- âœ… æ›´ç®€å•çš„éƒ¨ç½²å’Œè¿ç»´

**Redis ä¼˜åŠ¿**ï¼š
- âœ… æ”¯æŒåˆ†å¸ƒå¼
- âœ… ä¸°å¯Œçš„æ•°æ®ç»“æ„
- âœ… å‘å¸ƒ/è®¢é˜…
- âœ… æˆç†Ÿçš„ç”Ÿæ€

**é€‚ç”¨åœºæ™¯**ï¼š
- RogueMap: å•æœºåº”ç”¨ï¼ŒåµŒå…¥å¼ç¼“å­˜ï¼Œæè‡´æ€§èƒ½è¦æ±‚
- Redis: åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¤šåº”ç”¨å…±äº«ç¼“å­˜

## æ€§èƒ½ä¼˜åŒ–æŠ€å·§

### 1. é€‰æ‹©æœ€ä¼˜å­˜å‚¨æ¨¡å¼

```java
// æ¨èï¼šæ ¹æ®åœºæ™¯é€‰æ‹©
if (éœ€è¦æŒä¹…åŒ–) {
    RogueMap.mmap().persistent("data.db").build();
} else if (ä¸´æ—¶å¤§æ•°æ®å¤„ç†) {
    RogueMap.mmap().temporary().build();
} else {
    RogueMap.offHeap().build();
}
```

### 2. ä¼˜å…ˆä½¿ç”¨åŸå§‹ç±»å‹

```java
// æœ€ä¼˜ â­â­â­â­â­ - é›¶æ‹·è´
RogueMap<Long, Long> map = RogueMap.<Long, Long>offHeap()
    .keyCodec(PrimitiveCodecs.LONG)
    .valueCodec(PrimitiveCodecs.LONG)
    .build();
// è¯»å†™æ€§èƒ½æå‡ 2-5 å€

// æ¬¡ä¼˜ â­â­â­ - æœ‰åºåˆ—åŒ–å¼€é”€
RogueMap<String, User> map = RogueMap.<String, User>offHeap()
    .keyCodec(StringCodec.INSTANCE)
    .valueCodec(KryoObjectCodec.create(User.class))
    .build();
```

### 3. é«˜å¹¶å‘ä¼˜åŒ–

```java
// æ¨èï¼šæ ¹æ®çº¿ç¨‹æ•°è°ƒæ•´æ®µæ•°
int threads = Runtime.getRuntime().availableProcessors() * 2;
int segments = Math.max(64, Integer.highestOneBit(threads) * 2);

RogueMap<K, V> map = RogueMap.<K, V>offHeap()
    .segmentedIndex(segments)
    .build();
// é«˜å¹¶å‘æ€§èƒ½æå‡ 3-5 å€
```

### 4. å†…å­˜é¢„åˆ†é…

```java
// é¿å…é¢‘ç¹æ‰©å®¹
long recordCount = 10_000_000;
int avgRecordSize = 120;
double overhead = 1.2;

long requiredMemory = (long) (recordCount * avgRecordSize * overhead);

RogueMap<K, V> map = RogueMap.<K, V>offHeap()
    .maxMemory(requiredMemory)
    .build();
```

### 5. JVM å‚æ•°è°ƒä¼˜

```bash
# æ¨èé…ç½®ï¼ˆ8GB æœºå™¨ï¼‰
java -Xmx4g \
     -XX:MaxDirectMemorySize=4g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -jar app.jar

# è¯´æ˜:
# - Xmx: å †å†…å­˜ï¼ˆRogueMap åªéœ€è¦å°å †å†…å­˜ï¼‰
# - MaxDirectMemorySize: ç›´æ¥å†…å­˜ï¼ˆRogueMap æ•°æ®å­˜å‚¨ï¼‰
# - UseG1GC: æ¨èçš„ GC ç®—æ³•
```

## é€‰æ‹©å»ºè®®

### å¿«é€Ÿå†³ç­–æ ‘

```
æ˜¯å¦éœ€è¦æŒä¹…åŒ–ï¼Ÿ
â”œâ”€ æ˜¯ â†’ RogueMap Mmap æŒä¹…åŒ–
â”‚       å†™å…¥å¿« 1.95xï¼Œæ”¯æŒæŒä¹…åŒ–ï¼Œå †å†…å­˜ä½ 87%
â”‚
â””â”€ å¦ â†’ æ˜¯å¦éœ€è¦æè‡´è¯»å–æ€§èƒ½ï¼Ÿ
        â”œâ”€ æ˜¯ â†’ FastUtil æˆ– HashMap
        â”‚       çº¯å†…å­˜æ“ä½œï¼Œé€Ÿåº¦æœ€å¿«
        â”‚
        â””â”€ å¦ â†’ æ˜¯å¦ GC å‹åŠ›æ•æ„Ÿï¼Ÿ
                â”œâ”€ æ˜¯ â†’ RogueMap OffHeap
                â”‚       å †å†…å­˜ä½ 87%ï¼Œå¤§å¹…é™ä½ GC
                â”‚
                â””â”€ å¦ â†’ HashMap
                        ç®€å•åœºæ™¯ï¼Œæ— éœ€é…ç½®
```

### è¯¦ç»†æ¨èè¡¨

| éœ€æ±‚ | æ¨èæ–¹æ¡ˆ | ç†ç”± |
|-----|---------|------|
| å†™å…¥å¯†é›† + æŒä¹…åŒ– | **RogueMap Mmap æŒä¹…åŒ–** | å†™å…¥å¿« 1.95xï¼Œæ”¯æŒæŒä¹…åŒ–ï¼Œå†…å­˜å ç”¨ä½ 87% |
| æè‡´è¯»å–æ€§èƒ½ | **FastUtil æˆ– HashMap** | çº¯å†…å­˜è¯»å–ï¼Œé€Ÿåº¦æœ€å¿« |
| ä½ GC å‹åŠ› | **RogueMap ç³»åˆ—** | å †å†…å­˜å ç”¨ä½ 87%ï¼Œå¤§å¹…é™ä½ GC å‹åŠ› |
| æ•°æ®æŒä¹…åŒ– | **RogueMap Mmap æŒä¹…åŒ–** | å”¯ä¸€æ”¯æŒæŒä¹…åŒ–ä¸”æ€§èƒ½ä¼˜ç§€çš„æ–¹æ¡ˆ |
| ä¸´æ—¶å¤§æ•°æ®å¤„ç† | **RogueMap Mmap ä¸´æ—¶** | æ”¯æŒè¶…å¤§æ•°æ®é‡ï¼Œè‡ªåŠ¨æ¸…ç† |
| ç®€å•åœºæ™¯ | **HashMap** | API ç®€å•ï¼Œæ— éœ€é…ç½® |
| åˆ†å¸ƒå¼ | **Redis** | æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½² |

## æ€»ç»“

### RogueMap çš„æ ¸å¿ƒä»·å€¼

RogueMap ä¸æ˜¯ä¸ºäº†ç¢¾å‹ HashMap æˆ– FastUtil çš„æ€§èƒ½è€Œè®¾è®¡çš„ï¼ˆé‚£æ˜¯ä¸å¯èƒ½çš„ï¼‰ï¼Œè€Œæ˜¯ä¸ºäº†è§£å†³å®ƒä»¬**æ— æ³•è§£å†³çš„é—®é¢˜**ï¼š

1. **å †å†…å­˜çªç ´** - å‡å°‘ 87% å †å†…å­˜å ç”¨ï¼Œæ”¯æŒ 10 å€ä»¥ä¸Šæ•°æ®é‡
2. **æ•°æ®æŒä¹…åŒ–** - è¿›ç¨‹é‡å¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä¸šåŠ¡è¿ç»­æ€§ä¿éšœ
3. **ä½ GC å‹åŠ›** - é¿å…é¢‘ç¹ Full GCï¼Œåº”ç”¨è¿è¡Œæµç•…
4. **é«˜æ€§èƒ½å†™å…¥** - æ¯” HashMap å¿« 1.95 å€
5. **ç™¾ä¸‡çº§è¯»å–åå** - 176 ä¸‡ ops/sï¼Œæ»¡è¶³ç»å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯

### æ€§èƒ½æƒè¡¡æ˜¯å€¼å¾—çš„

è™½ç„¶è¯»å–é€Ÿåº¦çº¦ä¸º HashMap çš„ 1/10ï¼Œä½†ï¼š

- âœ… 176 ä¸‡ ops/s å¯¹äº 2C4G æœºå™¨å·²ç»éå¸¸ä¼˜ç§€
- âœ… æ¯” Redisï¼ˆç½‘ç»œï¼‰å¿« 100-200 å€
- âœ… é¿å…äº† GC å¯¼è‡´çš„é•¿æ—¶é—´åœé¡¿
- âœ… æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼Œä¸šåŠ¡è¿ç»­æ€§æ›´å¥½
- âœ… é™ä½å†…å­˜æˆæœ¬

### é€‚ç”¨äººç¾¤

RogueMap é€‚åˆä»¥ä¸‹åœºæ™¯çš„å¼€å‘è€…ï¼š

- ğŸ¯ å¤§æ•°æ®é‡ï¼ˆ100 ä¸‡+ æ¡ç›®ï¼‰é”®å€¼å­˜å‚¨
- ğŸ¯ GC å‹åŠ›æ•æ„Ÿçš„åº”ç”¨
- ğŸ¯ éœ€è¦æ•°æ®æŒä¹…åŒ–çš„åœºæ™¯
- ğŸ¯ å†™å…¥å¯†é›†å‹ä¸šåŠ¡
- ğŸ¯ éœ€è¦çªç ´ JVM å †å†…å­˜é™åˆ¶

å¦‚æœä½ çš„åœºæ™¯ç¬¦åˆä»¥ä¸Šä»»ä¸€æ¡ä»¶ï¼ŒRogueMap å°†æ˜¯æ¯” HashMapã€FastUtilã€Caffeine æ›´å¥½çš„é€‰æ‹©ã€‚

## è¿è¡Œæ€§èƒ½æµ‹è¯•

### å¿«é€Ÿæµ‹è¯•

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/bryan31/RogueMap.git
cd RogueMap

# è¿è¡Œç»¼åˆæ€§èƒ½å¯¹æ¯”æµ‹è¯•
mvn test -Dtest=MemoryUsageComparisonTest

# æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š
cat target/test-reports/performance.txt
```

### è‡ªå®šä¹‰æµ‹è¯•

```java
public class CustomBenchmark {
    public static void main(String[] args) {
        // åˆ›å»º RogueMap
        RogueMap<Long, User> map = RogueMap.<Long, User>mmap()
            .persistent("benchmark.db")
            .keyCodec(PrimitiveCodecs.LONG)
            .valueCodec(KryoObjectCodec.create(User.class))
            .build();

        // æµ‹è¯•å†™å…¥
        long start = System.currentTimeMillis();
        for (int i = 0; i < 1_000_000; i++) {
            map.put((long) i, new User("user" + i, i));
        }
        long writeTime = System.currentTimeMillis() - start;
        System.out.println("å†™å…¥è€—æ—¶: " + writeTime + "ms");

        // æµ‹è¯•è¯»å–
        start = System.currentTimeMillis();
        for (int i = 0; i < 1_000_000; i++) {
            map.get((long) i);
        }
        long readTime = System.currentTimeMillis() - start;
        System.out.println("è¯»å–è€—æ—¶: " + readTime + "ms");

        // æ¸…ç†
        map.close();
    }
}
```

## ä¸‹ä¸€æ­¥

- [å¿«é€Ÿå¼€å§‹](../guide/getting-started.md) - 5 åˆ†é’Ÿä¸Šæ‰‹ RogueMap
- [å­˜å‚¨æ¨¡å¼](../guide/storage-modes.md) - äº†è§£ä¸‰ç§å­˜å‚¨æ¨¡å¼çš„åŒºåˆ«
- [æœ€ä½³å®è·µ](../guide/best-practices.md) - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å»ºè®®
- [GitHub ä»“åº“](https://github.com/bryan31/RogueMap) - æŸ¥çœ‹æºç å’Œç¤ºä¾‹
